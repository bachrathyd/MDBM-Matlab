
%% Multi-Dimensional Bisection Method
% CTCR example - nautral double delay

% definition of the parameter space
%the limits and the initial mesh
ax=[];
ax(1).val=linspace(0,2*pi,8);%Phi1
ax(2).val=linspace(0,2*pi,8);%Phi1
ax(3).val=linspace(0.01,20,16).^2;%\omega


par.a=1;
par.zeta=0.2;
par.b=0.4;%0.7;

% v = VideoWriter('CTCR_for_neutral.mp4', 'MPEG-4'); % Create video object
% v.FrameRate = 20; % Set frame rate
% v.Quality = 100; % max quality

figure(1)
% open(v); % Open the video file

%%
%for c = 0:0.005:1.1
%%
c=0.3;%0.5
par.c=c;%0.21;
% function for which the roots are detected
bound_fuction_name='fval_CRCT';
% number of iteration
Niteration=6;%take care, the large values can easily lead to memory problem
mdbm_sol=mdbm(ax,bound_fuction_name,Niteration,[],par);



xyz=mdbm_sol.posinterp;
fi1=xyz(1,:);
fi2=xyz(2,:);
om=xyz(3,:);
figure(1)
clf
subplot(1,2,1)
%plot_mdbm(mdbm_sol,'k');

plot3(fi1,fi2,om,'.',MarkerSize=15)%,om
xlabel("Phi1")
ylabel("Phi2")
zlabel("omega")
set(gca, 'ZScale', 'log');
grid on


%% determine the instablility gradient (the direction where the system has more unstable rooths
instabgrad_phi12=mdbm_sol.gradient(:,1,:)+1i*mdbm_sol.gradient(:,2,:);
instabgrad=imag(bsxfun(@times,instabgrad_phi12,conj(instabgrad_phi12(end,:,:))));
%unifying the gradients
for kpos=1:size(instabgrad,3)
    instabgrad(:,kpos)=instabgrad(:,kpos)/norm(instabgrad(:,kpos));
end
posvect=mdbm_sol.posinterp;
%plot
hold on
% plot3(posvect(1,:),posvect(2,:),posvect(3,:),'r.')

quiver3(posvect(1,:),posvect(2,:),posvect(3,:),...
    instabgrad(1,:),instabgrad(2,:),instabgrad(3,:),3);

view(2)
%legend({'Stability limits (bifurcation curves)','applied constraints','instability gradient'})

instabgrad_tau12=mdbm_sol.gradient(:,1,:)+1i*mdbm_sol.gradient(:,2,:);
instabgrad_tau12(1,:,:)=instabgrad_tau12(1,:,:) .* instabgrad_tau12(3,:,:);
instabgrad_tau12(2,:,:)=instabgrad_tau12(2,:,:) .* instabgrad_tau12(3,:,:);
instabgrad_tau12=imag(bsxfun(@times,instabgrad_tau12,conj(instabgrad_tau12(end,:,:))));
%unifying the gradients
for kpos=1:size(instabgrad,2)
    instabgrad_tau12(:,kpos)=instabgrad_tau12(:,kpos)/norm(instabgrad_tau12(:,kpos));
end

figure(1)
subplot(1,2,2)
for k1=-5:5
    tau1=(fi1+k1*2*pi)./om;
   %igrad1=(instabgrad(1,:))./om;
    for k2=-5:5
        tau2=(fi2+k2*2*pi)./om;
        plot(tau1,tau2,'.',MarkerSize=15)%,om


        
quiver(tau1,tau2,...
    instabgrad_tau12(1,:),instabgrad_tau12(2,:));
      %  quiver(tau1,tau2,  igrad1,igrad2);
        hold on
    end
end
xlim([0,15])
xlabel("tau1")
ylim([0,15])
ylabel("tau2")

title({"c=",par.c})


drawnow;
%%
%     frame = getframe(gcf); % Capture current figure
%     writeVideo(v, frame);  % Write it to video
% end
%
%
% close(v); % Finalize video file

